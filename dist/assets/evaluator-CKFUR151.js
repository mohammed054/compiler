function p(s){return s!==null&&typeof s=="object"&&s.type==="list"}function v(s){return s!==null&&typeof s=="object"&&s.type==="vector"}function f(s){return s!==null&&typeof s=="object"&&s.type==="map"}function c(s){return s!==null&&typeof s=="object"&&s.type==="fn"}class m{env;macros;constructor(t){this.env=t||this.createGlobalEnv(),this.macros=new Map}createGlobalEnv(){const t={parent:null,bindings:{}};return t.bindings["+"]=this.primitiveFn(e=>e.reduce((n,i)=>n+i,0)),t.bindings["-"]=this.primitiveFn(e=>e.reduce((n,i)=>n-i)),t.bindings["*"]=this.primitiveFn(e=>e.reduce((n,i)=>n*i,1)),t.bindings["/"]=this.primitiveFn(e=>e.reduce((n,i)=>n/i)),t.bindings["="]=this.primitiveFn(e=>e[0]===e[1]),t.bindings["<"]=this.primitiveFn(e=>e[0]<e[1]),t.bindings[">"]=this.primitiveFn(e=>e[0]>e[1]),t.bindings["<="]=this.primitiveFn(e=>e[0]<=e[1]),t.bindings[">="]=this.primitiveFn(e=>e[0]>=e[1]),t.bindings["%"]=this.primitiveFn(e=>e[0]%e[1]),t.bindings.cons=this.primitiveFn(e=>{const n=e[1];return{type:"list",values:[e[0],...n.values]}}),t.bindings.car=this.primitiveFn(e=>e[0].values[0]),t.bindings.cdr=this.primitiveFn(e=>({type:"list",values:e[0].values.slice(1)})),t.bindings.list=this.primitiveFn(e=>({type:"list",values:e})),t.bindings.vec=this.primitiveFn(e=>({type:"vector",values:e[0].values||e[0]})),t.bindings["vec?"]=this.primitiveFn(e=>v(e[0])),t.bindings["list?"]=this.primitiveFn(e=>p(e[0])),t.bindings["map?"]=this.primitiveFn(e=>f(e[0])),t.bindings["fn?"]=this.primitiveFn(e=>c(e[0])),t.bindings["nil?"]=this.primitiveFn(e=>e[0]===null),t.bindings["true?"]=this.primitiveFn(e=>e[0]===!0),t.bindings["false?"]=this.primitiveFn(e=>e[0]===!1),t.bindings.print=this.primitiveFn(e=>(console.log(...e.map(n=>this.formatValue(n))),null)),t.bindings.str=this.primitiveFn(e=>e.map(n=>this.formatValue(n)).join("")),t.bindings["type-of"]=this.primitiveFn(e=>e[0]===null?"nil":typeof e[0]=="number"?"number":typeof e[0]=="string"?"string":e[0]===!0||e[0]===!1?"boolean":p(e[0])?"list":v(e[0])?"vector":f(e[0])?"map":c(e[0])?"fn":"unknown"),t}primitiveFn(t){return{type:"fn",params:[],body:[],env:this.env}}formatValue(t){if(t===null)return"nil";if(typeof t=="number")return String(t);if(typeof t=="string")return t;if(t===!0)return"true";if(t===!1)return"false";if(p(t))return`(${t.values.map(this.formatValue.bind(this)).join(" ")})`;if(v(t))return`[${t.values.map(this.formatValue.bind(this)).join(" ")}]`;if(f(t)){const e=[];return Object.entries(t.entries).forEach(([n,i])=>e.push(`${n} ${this.formatValue(i)}`)),`{${e.join(" ")}}`}return c(t)?"#<fn>":String(t)}evalProgram(t){const e=[];for(const n of t){const i=this.eval(n);e.push(i)}return e}eval(t){switch(t.type){case"Literal":return t.value;case"Symbol":{const e=this.env.bindings[t.value];if(e!==void 0)return e;if(this.env.parent)return this.lookupInParent(this.env.parent,t.value);throw new Error(`Undefined symbol: ${t.value}`)}case"List":{if(t.elements.length===0)return{type:"list",values:[]};const e=this.eval(t.elements[0]);if(c(e))return this.apply(e,t.elements.slice(1));if(e==="Symbol"&&typeof e=="string")return this.specialForm(e,t.elements.slice(1));if(typeof e=="string")return this.specialForm(e,t.elements.slice(1));throw new Error("Cannot call non-function")}case"Vector":return{type:"vector",values:t.elements.map(e=>this.eval(e))};case"Map":{const e={};for(const n of t.pairs){const i=this.eval(n.key);if(typeof i!="string")throw new Error("Map keys must be strings");e[i]=this.eval(n.value)}return{type:"map",entries:e}}case"Quote":return this.evalQuote(t.expr);case"Quasiquote":return this.evalQuasiquote(t.expr);case"Unquote":throw new Error("Unquote outside quasiquote");default:throw new Error(`Unknown expression type: ${t.type}`)}}lookupInParent(t,e){const n=t.bindings[e];if(n!==void 0)return n;if(t.parent)return this.lookupInParent(t.parent,e);throw new Error(`Undefined symbol: ${e}`)}apply(t,e){const n=e.map(r=>this.eval(r));if(t.body.length===0)return{type:"fn",params:t.params,body:[],env:t.env};const i={parent:t.env,bindings:{}};for(let r=0;r<t.params.length;r++)i.bindings[t.params[r]]=n[r];const u=new m(i);let o=null;for(const r of t.body)o=u.eval(r);return o}specialForm(t,e){switch(t){case"fn":{const n=(e[0]?.value||"").split(" ").filter(Boolean),i=e.slice(1);return{type:"fn",params:n,body:i,env:this.env}}case"def":{const n=e[0],i=this.eval(e[1]);return this.env.bindings[n.value]=i,null}case"defn":{const i=e[0].value,u=(e[1]?.value||"").split(" ").filter(Boolean),o=e.slice(2),r={type:"fn",params:u,body:o,env:this.env};return this.env.bindings[i]=r,null}case"defmacro":{const n=e[0].value,i=(e[1]?.value||"").split(" ").filter(Boolean),u=e.slice(2);return this.macros.set(n,{params:i,body:u}),null}case"let":{const n=e[0].elements,i=e.slice(1),u={parent:this.env,bindings:{}},o=new m(u);for(let l=0;l<n.length;l+=2){const a=n[l],h=this.eval(n[l+1]);u.bindings[a.value]=h}let r=null;for(const l of i)r=o.eval(l);return r}case"if":{const n=this.eval(e[0]);return n!==!1&&n!==null?this.eval(e[1]):e[2]?this.eval(e[2]):null}case"do":{let n=null;for(const i of e)n=this.eval(i);return n}default:{const n=this.macros.get(t);if(n){const i=this.expandMacro(t,n,e);return this.eval(i)}throw new Error(`Unknown special form: ${t}`)}}}expandMacro(t,e,n){const i={};for(let l=0;l<e.params.length;l++){const a=n[l];i[e.params[l]]=a?.value||""}const u={},o={value:0};for(const l of e.params){o.value++;const a=`${l}__gen${o.value}`;u[l]=a}return this.substitute(e.body[0],u)}substitute(t,e){switch(t.type){case"Symbol":{const n=e[t.value];return n?{type:"Symbol",value:n}:t}case"List":{if(t.elements.length>0){const n=t.elements[0];if(n.type==="Symbol"&&n.value==="unquote"){const i=e[t.elements[1].value];if(i)return{type:"Symbol",value:i}}}return{type:"List",elements:t.elements.map(n=>this.substitute(n,e))}}default:return t}}evalQuote(t){switch(t.type){case"Symbol":return t.value;case"List":return{type:"list",values:t.elements.map(e=>this.evalQuote(e))};case"Vector":return{type:"vector",values:t.elements.map(e=>this.evalQuote(e))};case"Map":return{type:"map",entries:{}};default:return this.eval(t)}}evalQuasiquote(t){switch(t.type){case"Unquote":return this.eval(t.expr);case"List":return{type:"list",values:t.elements.map(n=>this.evalQuasiquote(n))};default:return this.evalQuote(t)}}}export{m as Evaluator};
